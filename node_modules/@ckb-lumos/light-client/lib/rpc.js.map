{"version":3,"file":"rpc.js","names":["LightClientRPC","constructor","uri","getTipHeader","utils","deepCamel","request","fetchHeader","blockHash","params","getHeader","fetchTransaction","txHash","getTransaction","sendTransaction","tx","ParamsFormatter","toRawTransaction","getScripts","setScripts","scripts","map","script","scriptType","blockNumber","toScript","script_type","block_number","getCells","searchKey","order","limit","cursor","toGetCellsSearchKey","getCellsCapacity","toSearchKey","getGenesisBlock","getTransactions","toGetTransactionsSearchKey","ckbIndexerUrl","method","res","fetch","body","JSON","stringify","id","jsonrpc","headers","status","Error","data","json","error","undefined","result"],"sources":["../src/rpc.ts"],"sourcesContent":["import { HexString, utils, Header, Block } from \"@ckb-lumos/base\";\nimport { CKBComponents } from \"@ckb-lumos/rpc/lib/types/api\";\nimport { ParamsFormatter } from \"@ckb-lumos/rpc\";\n\nimport {\n  GetLiveCellsResult,\n  Order,\n  SearchKey,\n  GetCellsSearchKey,\n  GetTransactionsSearchKey,\n} from \"@ckb-lumos/ckb-indexer/lib/type\";\nimport {\n  toScript,\n  toSearchKey,\n  toGetCellsSearchKey,\n  toGetTransactionsSearchKey,\n} from \"@ckb-lumos/ckb-indexer/lib/paramsFormatter\";\nimport {\n  FetchHeaderResult,\n  FetchTransactionResult,\n  LightClientScript,\n  TransactionWithHeader,\n  LightClientTransactionList,\n} from \"./type\";\nimport fetch from \"cross-fetch\";\n\n/* c8 ignore next 100 */\nexport class LightClientRPC {\n  /**\n   *\n   * @param uri light client uri\n   */\n  constructor(private uri: string) {}\n\n  async getTipHeader(): Promise<Header> {\n    return utils.deepCamel(await request(this.uri, \"get_tip_header\"));\n  }\n\n  async fetchHeader(blockHash: string): Promise<FetchHeaderResult> {\n    const params = [blockHash];\n    return utils.deepCamel(await request(this.uri, \"fetch_header\", params));\n  }\n\n  async getHeader(blockHash: string): Promise<Header> {\n    const params = [blockHash];\n    return utils.deepCamel(await request(this.uri, \"get_header\", params));\n  }\n\n  async fetchTransaction(txHash: string): Promise<FetchTransactionResult> {\n    const params = [txHash];\n    return utils.deepCamel(\n      await request(this.uri, \"fetch_transaction\", params)\n    );\n  }\n\n  async getTransaction(txHash: string): Promise<TransactionWithHeader> {\n    const params = [txHash];\n    return utils.deepCamel(await request(this.uri, \"get_transaction\", params));\n  }\n\n  async sendTransaction(\n    tx: CKBComponents.RawTransaction\n  ): Promise<CKBComponents.Hash> {\n    const params = [ParamsFormatter.toRawTransaction(tx)];\n    return utils.deepCamel(await request(this.uri, \"send_transaction\", params));\n  }\n\n  async getScripts(): Promise<Array<LightClientScript>> {\n    return utils.deepCamel(await request(this.uri, \"get_scripts\"));\n  }\n\n  async setScripts(scripts: Array<LightClientScript>): Promise<void> {\n    const params = [\n      scripts.map(({ script, scriptType, blockNumber }) => ({\n        script: toScript(script),\n        script_type: scriptType,\n        block_number: blockNumber,\n      })),\n    ];\n    return utils.deepCamel(await request(this.uri, \"set_scripts\", params));\n  }\n\n  async getCells<WithData extends boolean = true>(\n    searchKey: GetCellsSearchKey<WithData>,\n    order: Order,\n    limit: HexString,\n    cursor?: string\n  ): Promise<GetLiveCellsResult<WithData>> {\n    const params = [toGetCellsSearchKey(searchKey), order, limit, cursor];\n    return utils.deepCamel(await request(this.uri, \"get_cells\", params));\n  }\n\n  async getCellsCapacity(\n    searchKey: SearchKey\n  ): Promise<CKBComponents.CellsCapacity> {\n    const params = [toSearchKey(searchKey)];\n    return utils.deepCamel(\n      await request(this.uri, \"get_cells_capacity\", params)\n    );\n  }\n\n  async getGenesisBlock(): Promise<Block> {\n    return utils.deepCamel(await request(this.uri, \"get_genesis_block\"));\n  }\n\n  async getTransactions<Grouped extends boolean = false>(\n    searchKey: GetTransactionsSearchKey<Grouped>,\n    order: Order,\n    limit: HexString,\n    cursor?: string\n  ): Promise<LightClientTransactionList<Grouped>> {\n    const params = [\n      toGetTransactionsSearchKey(searchKey),\n      order,\n      limit,\n      cursor,\n    ];\n    return utils.deepCamel(await request(this.uri, \"get_transactions\", params));\n  }\n}\n\n/* eslint-disable @typescript-eslint/no-explicit-any, @typescript-eslint/explicit-module-boundary-types */\nconst request = async (\n  ckbIndexerUrl: string,\n  method: string,\n  params?: any\n): Promise<any> => {\n  const res = await fetch(ckbIndexerUrl, {\n    method: \"POST\",\n    body: JSON.stringify({\n      id: 0,\n      jsonrpc: \"2.0\",\n      method,\n      params,\n    }),\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n  });\n  if (res.status !== 200) {\n    throw new Error(`indexer request failed with HTTP code ${res.status}`);\n  }\n  const data = await res.json();\n  if (data.error !== undefined) {\n    throw new Error(\n      `indexer request rpc failed with error: ${JSON.stringify(data.error)}`\n    );\n  }\n  return data.result;\n};\n/* eslint-enalbe @typescript-eslint/no-explicit-any, @typescript-eslint/explicit-module-boundary-types */\n"],"mappings":"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"}